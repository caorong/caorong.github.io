<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>java native and netty | lelouchcr&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css">
  <!-- <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'> -->
</head>

<body>
  <nav class="app-nav">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives">archive</a>
    
  
    
      <a href="/atom.xml">rss</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2019/06/07/java-native-quick-start/">java native and netty</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">June 07 2019</p>
  </section>

  <section class="article-entry">
    <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>这篇主要讲讲 java native</p>
<p>java native 可以让 java 虚拟机 直接和底层交互, 一般用于比如系统相关的资源(比如 netty-native-epoll)，或者一些别的目的(将加解密lib封装到底层，增加破解难度)</p>
<p></p>
<h1 id="JNI-教程"><a href="#JNI-教程" class="headerlink" title="JNI 教程"></a>JNI 教程</h1><h2 id="JNI-with-c"><a href="#JNI-with-c" class="headerlink" title="JNI with c"></a>JNI with c</h2><h3 id="1-一个用了-java-native-的-HelloJNI-java"><a href="#1-一个用了-java-native-的-HelloJNI-java" class="headerlink" title="1. 一个用了 java native 的 HelloJNI.java"></a>1. 一个用了 java native 的 HelloJNI.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloJNI</span> </span>&#123;  <span class="comment">// Save as HelloJNI.java</span></span><br><span class="line">   <span class="keyword">static</span> &#123;</span><br><span class="line">      System.loadLibrary(<span class="string">"hello"</span>); <span class="comment">// Load native library hello.dll (Windows) or libhello.so (Unixes)</span></span><br><span class="line">                                   <span class="comment">//  at runtime</span></span><br><span class="line">                                   <span class="comment">// This library contains a native method called sayHello()</span></span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Declare an instance native method sayHello() which receives no parameter and returns void</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Test Driver</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">new</span> HelloJNI().sayHello();  <span class="comment">// Create an instance and invoke the native method</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-编译java-文件，生成native-头文件"><a href="#2-编译java-文件，生成native-头文件" class="headerlink" title="2. 编译java 文件，生成native 头文件"></a>2. 编译java 文件，生成native 头文件</h3><p>java8 之后可以直接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -h . HelloJNI.java</span><br></pre></td></tr></table></figure>
<p>java8 之前需要按照以前步骤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac HelloJNI.java</span><br><span class="line">javah HelloJNI</span><br></pre></td></tr></table></figure>
<p>HelloJNI.h 文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class HelloJNI */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_HelloJNI</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_HelloJNI</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * 注： 该方法对应了 java 代码里面 native 的接口，c代码需要实现他</span><br><span class="line"> * </span><br><span class="line"> * Class:     HelloJNI</span><br><span class="line"> * Method:    sayHello</span><br><span class="line"> * Signature: ()V</span><br><span class="line"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_HelloJNI_sayHello</span></span><br><span class="line">  <span class="params">(JNIEnv *, jobject)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h3 id="3-实现c-程序-HelloJNI-c"><a href="#3-实现c-程序-HelloJNI-c" class="headerlink" title="3. 实现c 程序 HelloJNI.c"></a>3. 实现c 程序 HelloJNI.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Save as "HelloJNI.c"</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span>        // JNI header provided by JDK</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>      // C Standard IO Header</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"HelloJNI.h"</span>   // Generated</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Implementation of the native method sayHello()</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_HelloJNI_sayHello</span><span class="params">(JNIEnv *env, jobject thisObj)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"Hello World!\n"</span>);</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-编译-c程序-HelloJNI-c"><a href="#4-编译-c程序-HelloJNI-c" class="headerlink" title="4. 编译 c程序 HelloJNI.c"></a>4. 编译 c程序 HelloJNI.c</h3><h5 id="mac-linux"><a href="#mac-linux" class="headerlink" title="mac/linux"></a>mac/linux</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">## 设置 JAVA_HOME</span><br><span class="line">export JAVA_HOME=`/usr/libexec/java_home -v 1.8`</span><br><span class="line"></span><br><span class="line">## 编译 on mac</span><br><span class="line">gcc -I&quot;$JAVA_HOME/include&quot; -I&quot;$JAVA_HOME/include/darwin&quot; -dynamiclib -o libhello.dylib HelloJNI.c</span><br><span class="line"></span><br><span class="line">## 编译 on linux</span><br><span class="line">gcc -fPIC -I&quot;$JAVA_HOME/include&quot; -I&quot;$JAVA_HOME/include/linux&quot; -shared -o libhello.so HelloJNI.c</span><br><span class="line"></span><br><span class="line">## 运行</span><br><span class="line"></span><br><span class="line">java -cp . -Djava.library.path=. HelloJNI</span><br></pre></td></tr></table></figure>
<h3 id="java-library-path-是什么"><a href="#java-library-path-是什么" class="headerlink" title="java.library.path 是什么?"></a>java.library.path 是什么?</h3><p>System.loadLibrary() 默认会从 ‘java.library.path’ 这个java参数指定的路径下寻找动态链接库, 这个值一般为当前执行java 进程的环境的 PATH 的复制。</p>
<p>在我的mac下默认值是(注： 最后一个<code>.</code> 表示应用根目录):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/caorong/Library/Java/Extensions:/Library/Java/Extensions:/Network/Library/Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java:.</span><br></pre></td></tr></table></figure>
<h3 id="java-的native-方法-如何对应到对应的动态链接库？"><a href="#java-的native-方法-如何对应到对应的动态链接库？" class="headerlink" title="java 的native 方法 如何对应到对应的动态链接库？"></a>java 的native 方法 如何对应到对应的动态链接库？</h3><p>通过包名</p>
<p>比如, 我的代码是在 默认包下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>那么生成的 native 接口为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Header for class org_cr_HelloJNI */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_org_cr_HelloJNI</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_org_cr_HelloJNI</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * Class:     org_cr_HelloJNI</span><br><span class="line"> * Method:    sayHello</span><br><span class="line"> * Signature: ()V</span><br><span class="line"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_org_cr_HelloJNI_sayHello</span></span><br><span class="line">  <span class="params">(JNIEnv *, jobject)</span></span>;</span><br></pre></td></tr></table></figure>
<p>如果在 org.cr 这个包下的话</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.cr;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Header for class org_cr_HelloJNI */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_org_cr_HelloJNI</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_org_cr_HelloJNI</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * Class:     org_cr_HelloJNI</span><br><span class="line"> * Method:    sayHello</span><br><span class="line"> * Signature: ()V</span><br><span class="line"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_org_cr_HelloJNI_sayHello</span></span><br><span class="line">  <span class="params">(JNIEnv *, jobject)</span></span>;</span><br></pre></td></tr></table></figure>
<p>注意，生成的 jni 的方法名上带有java端的包名。</p>
<p>所以，其实native的动态链接库，并没有外部索引，都是通过方法名来映射的。</p>
<p>java 端 native 方法对应的 包名和 native 的方法名一一对应，不能乱改。</p>
<h2 id="java-和-c-的类型映射"><a href="#java-和-c-的类型映射" class="headerlink" title="java 和 c 的类型映射"></a>java 和 c 的类型映射</h2><p>java的 jni.h 头文件路径位于 $JAVA_HOME/include/jni.h</p>
<p>java 的native 函数需要传递参数，以下是 他们的类型映射关系</p>
<h3 id="基本类型：-java-类型和c-一一对应-栈上分配内存，无需手动释放"><a href="#基本类型：-java-类型和c-一一对应-栈上分配内存，无需手动释放" class="headerlink" title="基本类型： java 类型和c 一一对应, 栈上分配内存，无需手动释放"></a>基本类型： java 类型和c 一一对应, 栈上分配内存，无需手动释放</h3><table>
<thead>
<tr>
<th>java类型</th>
<th>native类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>void</td>
<td>void</td>
<td></td>
</tr>
<tr>
<td>byte</td>
<td>jbyte</td>
<td>8位 有符号</td>
</tr>
<tr>
<td>int</td>
<td>jint</td>
<td>32位 有符号</td>
</tr>
<tr>
<td>float</td>
<td>jfloat</td>
<td>32位 有符号</td>
</tr>
<tr>
<td>double</td>
<td>jdouble</td>
<td>64位 有符号</td>
</tr>
<tr>
<td>char</td>
<td>jchar</td>
<td>16位 无符号</td>
</tr>
<tr>
<td>long</td>
<td>jlong</td>
<td>64位 有符号</td>
</tr>
<tr>
<td>short</td>
<td>jshort</td>
<td>16位 有符号</td>
</tr>
<tr>
<td>boolean</td>
<td>jboolean</td>
<td>8位 无符号</td>
</tr>
</tbody>
</table>
<p>基本类型在c代码中可以直接和c类型一起使用.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">double</span> <span class="title">average</span><span class="params">(<span class="keyword">int</span> n1, <span class="keyword">int</span> n2)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jdouble JNICALL <span class="title">Java_TestJNIPrimitive_average</span></span><br><span class="line">          <span class="params">(JNIEnv *env, jobject thisObj, jint n1, jint n2)</span> </span>&#123;</span><br><span class="line">   jdouble result;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"In C, the numbers are %d and %d\n"</span>, n1, n2);</span><br><span class="line">   result = ((jdouble)n1 + n2) / <span class="number">2.0</span>;</span><br><span class="line">   <span class="comment">// jint is mapped to int, jdouble is mapped to double</span></span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="引用类型-需要多做一些转换，以及需要手动释放java容器对象"><a href="#引用类型-需要多做一些转换，以及需要手动释放java容器对象" class="headerlink" title="引用类型:  需要多做一些转换，以及需要手动释放java容器对象"></a>引用类型:  需要多做一些转换，以及需要手动释放java容器对象</h3><table>
<thead>
<tr>
<th>java类型</th>
<th>native类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>java.lang.String</td>
<td>jobject</td>
<td>所有java对象</td>
</tr>
<tr>
<td>java.lang.object</td>
<td>jstring</td>
<td>string</td>
</tr>
<tr>
<td>java.lang.Class</td>
<td>jclass</td>
<td>java class 对象</td>
</tr>
<tr>
<td>java.lang.Throwable</td>
<td>jthrowable</td>
<td>java throwable 对象</td>
</tr>
</tbody>
</table>
<h4 id="string-相关函数"><a href="#string-相关函数" class="headerlink" title="string 相关函数"></a>string 相关函数</h4><p>主要是一些转换，手动释放函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">jstring (JNICALL *NewString)</span><br><span class="line">  (JNIEnv *env, <span class="keyword">const</span> jchar *unicode, jsize len);</span><br><span class="line">jsize (JNICALL *GetStringLength)</span><br><span class="line">  (JNIEnv *env, jstring str);</span><br><span class="line"><span class="keyword">const</span> jchar *(JNICALL *GetStringChars)</span><br><span class="line">  (JNIEnv *env, jstring str, jboolean *isCopy);</span><br><span class="line"><span class="keyword">void</span> (JNICALL *ReleaseStringChars)</span><br><span class="line">  (JNIEnv *env, jstring str, <span class="keyword">const</span> jchar *chars);</span><br><span class="line"></span><br><span class="line">jstring (JNICALL *NewStringUTF)</span><br><span class="line">  (JNIEnv *env, <span class="keyword">const</span> <span class="keyword">char</span> *utf);</span><br><span class="line">jsize (JNICALL *GetStringUTFLength)</span><br><span class="line">  (JNIEnv *env, jstring str);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* (JNICALL *GetStringUTFChars</span><br></pre></td></tr></table></figure>
<p>代码例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> String <span class="title">sayHelloString</span><span class="params">(String str)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">Java_HelloJNI_sayHelloString</span><span class="params">(JNIEnv *env, jobject thisObj, jstring inJNIStr)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *inCStr = (*env)-&gt;GetStringUTFChars(env, inJNIStr, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == inCStr) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Step 2: Perform its intended operations</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"In C, the received string is: %s\n"</span>, inCStr);</span><br><span class="line">   (*env)-&gt;ReleaseStringUTFChars(env, inJNIStr, inCStr);  <span class="comment">// release resources</span></span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Prompt user for a C-string</span></span><br><span class="line">   <span class="keyword">char</span> outCStr[<span class="number">128</span>];</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"Enter a String: "</span>);</span><br><span class="line">   <span class="built_in">scanf</span>(<span class="string">"%s"</span>, outCStr);    <span class="comment">// not more than 127 characters</span></span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Step 3: Convert the C-string (char*) into JNI String (jstring) and return</span></span><br><span class="line">   <span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, outCStr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="object-相关函数"><a href="#object-相关函数" class="headerlink" title="object 相关函数"></a>object 相关函数</h4><p>主要是通过反射来读写 object 对象的field</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jclass <span class="title">GetObjectClass</span><span class="params">(JNIEnv *env, jobject obj)</span></span>;</span><br><span class="line">   <span class="comment">// Returns the class of an object.</span></span><br><span class="line">   </span><br><span class="line"><span class="function">jfieldID <span class="title">GetFieldID</span><span class="params">(JNIEnv *env, jclass cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *sig)</span></span>;</span><br><span class="line">  <span class="comment">// Returns the field ID for an instance variable of a class.</span></span><br><span class="line"> </span><br><span class="line">NativeType Get&lt;type&gt;Field(JNIEnv *env, jobject obj, jfieldID fieldID);</span><br><span class="line"><span class="keyword">void</span> Set&lt;type&gt;Field(JNIEnv *env, jobject obj, jfieldID fieldID, NativeType value);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">modifyInstanceVariable</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_TestJNIInstanceVariable_modifyInstanceVariable</span></span><br><span class="line">          <span class="params">(JNIEnv *env, jobject thisObj)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Get a reference to this object's class</span></span><br><span class="line">   jclass thisClass = (*env)-&gt;GetObjectClass(env, thisObj);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// int</span></span><br><span class="line">   <span class="comment">// Get the Field ID of the instance variables "number"</span></span><br><span class="line">   jfieldID fidNumber = (*env)-&gt;GetFieldID(env, thisClass, <span class="string">"number"</span>, <span class="string">"I"</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == fidNumber) <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Get the int given the Field ID</span></span><br><span class="line">   jint number = (*env)-&gt;GetIntField(env, thisObj, fidNumber);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"In C, the int is %d\n"</span>, number);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Change the variable</span></span><br><span class="line">   number = <span class="number">99</span>;</span><br><span class="line">   (*env)-&gt;SetIntField(env, thisObj, fidNumber, number);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Get the Field ID of the instance variables "message"</span></span><br><span class="line">   jfieldID fidMessage = (*env)-&gt;GetFieldID(env, thisClass, <span class="string">"message"</span>, <span class="string">"Ljava/lang/String;"</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == fidMessage) <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// String</span></span><br><span class="line">   <span class="comment">// Get the object given the Field ID</span></span><br><span class="line">   jstring message = (*env)-&gt;GetObjectField(env, thisObj, fidMessage);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Create a C-string with the JNI String</span></span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *cStr = (*env)-&gt;GetStringUTFChars(env, message, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == cStr) <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"In C, the string is %s\n"</span>, cStr);</span><br><span class="line">   (*env)-&gt;ReleaseStringUTFChars(env, message, cStr);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Create a new C-string and assign to the JNI string</span></span><br><span class="line">   message = (*env)-&gt;NewStringUTF(env, <span class="string">"Hello from C"</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == message) <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// modify the instance variables</span></span><br><span class="line">   (*env)-&gt;SetObjectField(env, thisObj, fidMessage, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="所有基本类型的-数组类型-数组容器-也需要手动释放"><a href="#所有基本类型的-数组类型-数组容器-也需要手动释放" class="headerlink" title="所有基本类型的 数组类型: 数组容器 也需要手动释放"></a>所有基本类型的 数组类型: 数组容器 也需要手动释放</h3><p>包括以下类型</p>
<p>jintArray, jbyteArray, jshortArray, jlongArray, jfloatArray, jdoubleArray, jcharArray and jbooleanArray</p>
<p>相关函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NativeType * Get&lt;PrimitiveType&gt;ArrayElements(JNIEnv *env, ArrayType <span class="built_in">array</span>, jboolean *isCopy);</span><br><span class="line"><span class="keyword">void</span> Release&lt;PrimitiveType&gt;ArrayElements(JNIEnv *env, ArrayType <span class="built_in">array</span>, NativeType *elems, jint mode);</span><br><span class="line"><span class="keyword">void</span> Get&lt;PrimitiveType&gt;ArrayRegion(JNIEnv *env, ArrayType <span class="built_in">array</span>, jsize start, jsize length, NativeType *buffer);</span><br><span class="line"><span class="keyword">void</span> Set&lt;PrimitiveType&gt;ArrayRegion(JNIEnv *env, ArrayType <span class="built_in">array</span>, jsize start, jsize length, <span class="keyword">const</span> NativeType *buffer);</span><br><span class="line">ArrayType New&lt;PrimitiveType&gt;Array(JNIEnv *env, jsize length);</span><br><span class="line">v</span><br></pre></td></tr></table></figure>
<p>例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">double</span>[] sumAndAverage(<span class="keyword">int</span>[] numbers);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jdoubleArray JNICALL <span class="title">Java_TestJNIPrimitiveArray_sumAndAverage</span></span><br><span class="line">          <span class="params">(JNIEnv *env, jobject thisObj, jintArray inJNIArray)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Step 1: Convert the incoming JNI jintarray to C's jint[]</span></span><br><span class="line">   jint *inCArray = (*env)-&gt;GetIntArrayElements(env, inJNIArray, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == inCArray) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   jsize length = (*env)-&gt;GetArrayLength(env, inJNIArray);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Step 2: Perform its intended operations</span></span><br><span class="line">   jint sum = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">int</span> i;</span><br><span class="line">   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">      sum += inCArray[i];</span><br><span class="line">   &#125;</span><br><span class="line">   jdouble average = (jdouble)sum / length;</span><br><span class="line">   (*env)-&gt;ReleaseIntArrayElements(env, inJNIArray, inCArray, <span class="number">0</span>); <span class="comment">// release resources</span></span><br><span class="line"> </span><br><span class="line">   jdouble outCArray[] = &#123;sum, average&#125;;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Step 3: Convert the C's Native jdouble[] to JNI jdoublearray, and return</span></span><br><span class="line">   jdoubleArray outJNIArray = (*env)-&gt;NewDoubleArray(env, <span class="number">2</span>);  <span class="comment">// allocate</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == outJNIArray) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   (*env)-&gt;SetDoubleArrayRegion(env, outJNIArray, <span class="number">0</span> , <span class="number">2</span>, outCArray);  <span class="comment">// copy</span></span><br><span class="line">   <span class="keyword">return</span> outJNIArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="实际使用案例"><a href="#实际使用案例" class="headerlink" title="实际使用案例"></a>实际使用案例</h1><p>netty-native 如何设计并使用动态链接库</p>
<h2 id="netty-native-如果进行使用一个jar支持多个环境？"><a href="#netty-native-如果进行使用一个jar支持多个环境？" class="headerlink" title="netty-native 如果进行使用一个jar支持多个环境？"></a>netty-native 如果进行使用一个jar支持多个环境？</h2><p>对于不同环境对不同链接库不同的命名</p>
<p><code>netty_transport_native_epoll_{os.arch}</code></p>
<h2 id="如果对-nettynative-的动态链接库做了一些自定义，如何不和官方提供的作区分？"><a href="#如果对-nettynative-的动态链接库做了一些自定义，如何不和官方提供的作区分？" class="headerlink" title="如果对 nettynative 的动态链接库做了一些自定义，如何不和官方提供的作区分？"></a>如果对 nettynative 的动态链接库做了一些自定义，如何不和官方提供的作区分？</h2><p>动态链接库名字上带上包名</p>
<p>官方的 <code>netty_transport_native_epoll_{os.arch}</code></p>
<p>自己shaded 的package为 <code>com.xx.shaded.io.netty.xx</code></p>
<p>那么 动态链接库名字则需要补上 自定义的前缀 <code>libcom_xx_shaded_netty_transport_native_epoll_{os.arch}</code></p>
<h2 id="如何读取jar-里面的-动态链接库？"><a href="#如何读取jar-里面的-动态链接库？" class="headerlink" title="如何读取jar 里面的 动态链接库？"></a>如何读取jar 里面的 动态链接库？</h2><p>会从jar内读取当前系统的动态链接库，copy到系统某个临时目录下 </p>
<p><code>jar:META-INF/native/libcom_xx_shaded_netty_transport_native_epoll_{os.arch}</code></p>
<p>copy to </p>
<p><code>/tmp/libcom_xx_shaded_netty_transport_native_epoll_{os.arch}_{random number}.so</code></p>
<p>注： 在 netty 中该copy的方式是作为最后的保底方案。</p>
<p>因为这个动态链接库是机器相关的，不同系统，可能会有不兼容，所以，最好的方案还是在每台机器上自己编译动态链接库后放到 java.library.path</p>
<p>附 netty中 寻找动态库的顺序</p>
<ol>
<li>java.library.path 中找 libcom_xx_shaded_netty_transport_native<em>epoll</em>{os.arch}, 用 AccessController 在满足权限的条件下，load </li>
<li>同上，但是不会通过 AccessController 以授权方式加载</li>
<li>寻找jar包内部  <code>jar:META-INF/native/libcom_xx_shaded_netty_transport_native_epoll_{os.arch}</code> 的动态库，copy到 临时文件后， load 该临时生成的动态链接库</li>
</ol>
<h2 id="netty-如何保证java代码包名被-shaded-修改-后-还能索引到原来的方法？"><a href="#netty-如何保证java代码包名被-shaded-修改-后-还能索引到原来的方法？" class="headerlink" title="netty 如何保证java代码包名被 shaded (修改) 后 还能索引到原来的方法？"></a>netty 如何保证java代码包名被 shaded (修改) 后 还能索引到原来的方法？</h2><p>netty native 的c代码，利用了动态实现JNI 的方法。</p>
<p>JNI 在加载时， 会调用 <code>JNI_OnLoad</code> 卸载时会调用 <code>JNI_UnLoad</code></p>
<p>所以，他利用 <code>JNI_OnLoad</code> 时，获取了当前动态连接路的 path, 由于动态链接库有着上面的规则，所以他会把上面自己添加的 shaded 的包名(packagePrefix)，存在内存里面，然后, 依次动态注册函数名字(前缀会添加 packagePrefix).</p>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p><a href="https://www3.ntu.edu.sg/home/ehchua/programming/java/JavaNativeInterface.html" target="_blank" rel="external">https://www3.ntu.edu.sg/home/ehchua/programming/java/JavaNativeInterface.html</a></p>
<p><a href="https://www.developer.com/java/data/jni-data-type-mapping-to-cc.html" target="_blank" rel="external">https://www.developer.com/java/data/jni-data-type-mapping-to-cc.html</a></p>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="https://gravatar.cat.net/avatar/f6adb1529491a56dbe31c57d519585f5?s=400&r=g" alt="avatar" />
    <div class="grid-item">
      <p class="title"> lelouchcr's blog </p>
      <p class="subtitle">  </p>
    <div>
  </section>

  <section class="share-btns">
    <!-- <p> share it if you like it~ </p> -->
    <a
  class="twitter-share-button"
  data-size="large"
  data-via="DrakeLeung"
  href="https://twitter.com/intent/tweet?text= id="概述"><a href="#概"
>
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'caorong';
  
  var disqus_url = 'http://caorong.github.io/2019/06/07/java-native-quick-start/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
  

<script>
    setTimeout(function() {
            var hjs = document.createElement('script');
            hjs.setAttribute('src', 'https://acgart.download/rand?ratio=0.625&range=0.2&source=pixiv&encode=jsc&func=lgallery');
            document.body.appendChild(hjs);
        }, 0);

    function lgallery(option) {
            console.log(option);
            var bgimg = document.createElement('img');
            bgimg.setAttribute('src', option.p_ori);
            bgimg.setAttribute('id', 'bkImg');
            bgimg.setAttribute('onmousedown', 'return false');
            document.body.appendChild(bgimg);
        }

</script>

</main>

</body>
</html>
